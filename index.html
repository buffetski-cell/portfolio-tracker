<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<meta name="theme-color" content="#0f1117" />
<link rel="manifest" href="manifest.json" />
<title>Portfolio Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600&display=swap');

  :root {
    --bg: #0f1117;
    --bg-card: #1a1d27;
    --bg-card-inner: #222633;
    --text-primary: #f0f0f3;
    --text-secondary: #8a8d9a;
    --accent: #00e5a0;
    --accent-dim: rgba(0, 229, 160, 0.12);
    --red: #ff5c5c;
    --red-dim: rgba(255, 92, 92, 0.12);
    --blue: #5b9ef5;
    --blue-dim: rgba(91, 158, 245, 0.12);
    --border: rgba(255,255,255,0.06);
    --radius: 16px;
  }

  /* Light mode */
  :root.light-mode {
    --bg: #f5f7fa;
    --bg-card: #ffffff;
    --bg-card-inner: #f8f9fb;
    --text-primary: #1a1d27;
    --text-secondary: #6b7280;
    --accent: #00a876;
    --accent-dim: rgba(0, 168, 118, 0.08);
    --red: #dc2626;
    --red-dim: rgba(220, 38, 38, 0.08);
    --blue: #3b82f6;
    --blue-dim: rgba(59, 130, 246, 0.08);
    --border: rgba(0,0,0,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    min-height: 100vh;
    min-height: 100dvh;
    padding: 0;
    overflow-x: hidden;
  }

  /* â”€â”€â”€ LOADING / AUTH SCREENS â”€â”€â”€ */
  .screen { display: none; min-height: 100dvh; flex-direction: column; align-items: center; justify-content: center; padding: 40px 24px; text-align: center; }
  .screen.active { display: flex; }

  .logo-wrap { margin-bottom: 32px; }
  .logo-icon {
    width: 72px; height: 72px; border-radius: 20px;
    background: linear-gradient(135deg, var(--accent), var(--blue));
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto; font-size: 32px;
    box-shadow: 0 8px 32px rgba(0,229,160,0.25);
  }
  .logo-wrap h1 { margin-top: 16px; font-family: 'Space Mono', monospace; font-size: 22px; letter-spacing: -0.5px; }
  .logo-wrap p { color: var(--text-secondary); font-size: 13px; margin-top: 6px; }

  .btn {
    display: inline-flex; align-items: center; gap: 10px;
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text-primary); padding: 14px 28px; border-radius: 14px;
    font-size: 15px; font-weight: 500; cursor: pointer;
    transition: background 0.2s, border-color 0.2s, transform 0.1s;
    margin-top: 24px; text-decoration: none;
  }
  .btn:active { transform: scale(0.96); }
  .btn:hover { background: var(--bg-card-inner); border-color: rgba(255,255,255,0.15); }
  .btn svg { width: 20px; height: 20px; }

  .spinner {
    width: 40px; height: 40px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.7s linear infinite; margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading-screen p { margin-top: 16px; color: var(--text-secondary); font-size: 14px; }

  /* â”€â”€â”€ MAIN DASHBOARD â”€â”€â”€ */
  .dashboard { padding: 0; }

  /* Header */
  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 56px 20px 12px;
    background: var(--bg);
    position: sticky; top: 0; z-index: 10;
  }
  .header h2 { font-family: 'Space Mono', monospace; font-size: 18px; }
  .header-actions { display: flex; gap: 8px; }
  .icon-btn {
    width: 36px; height: 36px; border-radius: 10px;
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text-secondary); display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
  }
  .icon-btn:active { background: var(--bg-card-inner); }
  .icon-btn svg { width: 18px; height: 18px; }
  
  /* Theme toggle icons */
  .theme-icon { display: none; }
  :root.light-mode .theme-icon.sun { display: block; }
  :root:not(.light-mode) .theme-icon.moon { display: block; }

  /* Body scroll area */
  .dash-body { padding: 8px 20px 40px; }

  /* Hero card: total + daily change */
  .hero-card {
    background: var(--bg-card); border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 24px 20px 20px;
    margin-bottom: 16px;
    position: relative; overflow: hidden;
  }
  .hero-card::before {
    content: ''; position: absolute; top: -40px; right: -40px;
    width: 140px; height: 140px; border-radius: 50%;
    background: radial-gradient(circle, rgba(0,229,160,0.1) 0%, transparent 70%);
    pointer-events: none;
  }
  .hero-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 4px; }
  .hero-value { font-family: 'Space Mono', monospace; font-size: 32px; font-weight: 700; letter-spacing: -1px; }
  .hero-change {
    display: inline-flex; align-items: center; gap: 5px;
    margin-top: 10px; padding: 5px 10px; border-radius: 8px;
    font-size: 13px; font-weight: 600;
  }
  .hero-change.positive { background: var(--accent-dim); color: var(--accent); }
  .hero-change.negative { background: var(--red-dim); color: var(--red); }
  .hero-change svg { width: 12px; height: 12px; }
  .hero-meta { display: flex; justify-content: space-between; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
  .hero-meta-item .hm-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); }
  .hero-meta-item .hm-val { font-size: 14px; font-weight: 600; margin-top: 2px; }

  /* Chart toggle button */
  .chart-toggle-btn {
    width: 28px; height: 28px; border-radius: 8px;
    background: var(--bg-card-inner); border: 1px solid var(--border);
    color: var(--text-secondary); display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
  }
  .chart-toggle-btn:active { background: var(--bg-card); }
  .chart-toggle-btn svg { width: 14px; height: 14px; }

  /* Charts section */
  .charts-section {
    background: var(--bg-card); border-radius: var(--radius);
    border: 1px solid var(--border); padding: 16px; margin-bottom: 16px;
  }
  .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
  .chart-tabs { display: flex; gap: 4px; }
  .chart-tab {
    padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500;
    background: transparent; border: 1px solid var(--border); color: var(--text-secondary);
    cursor: pointer; transition: all 0.2s;
  }
  .chart-tab.active { background: var(--bg-card-inner); color: var(--text-primary); border-color: var(--accent); }
  .chart-periods { display: flex; gap: 4px; }
  .period-btn {
    padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 500;
    background: transparent; border: 1px solid var(--border); color: var(--text-secondary);
    cursor: pointer; transition: all 0.2s;
  }
  .period-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .chart-container { width: 100%; height: 240px; position: relative; }
  .chart-message { text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 12px; }

  /* Sleeves */
  .sleeve-card {
    background: var(--bg-card); border-radius: var(--radius);
    border: 1px solid var(--border); overflow: hidden; margin-bottom: 10px;
  }
  .sleeve-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 16px; cursor: pointer; transition: background 0.15s;
  }
  .sleeve-row:active { background: var(--bg-card-inner); }
  .sleeve-name { font-size: 14px; font-weight: 600; }
  .sleeve-allocation { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
  .sleeve-row-right { text-align: right; }
  .sleeve-value { font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 600; }
  .sleeve-change { font-size: 11px; margin-top: 2px; }
  .sleeve-detail {
    max-height: 0; overflow: hidden; transition: max-height 0.35s ease;
    border-top: 1px solid var(--border);
  }
  .sleeve-detail.open { max-height: 600px; }
  .sleeve-holdings-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
  .sleeve-holdings-header { 
    font-size: 10px; text-transform: uppercase; letter-spacing: 1px; 
    color: var(--text-secondary); font-weight: 600; margin-bottom: 8px; 
  }
  .sleeve-holding-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03);
  }
  .sleeve-holding-row:last-child { border-bottom: none; }
  .sleeve-holding-ticker { font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 600; }
  .sleeve-holding-name { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
  .sleeve-holding-value { font-size: 13px; font-weight: 600; }
  .sleeve-holding-pl { font-size: 10px; margin-top: 2px; }

  /* Section titles */
  .section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin: 20px 0 10px; font-weight: 600; }

  /* P/L Summary Card */
  .pl-row {
    display: flex; gap: 10px; margin-bottom: 16px;
  }
  .pl-mini {
    flex: 1; background: var(--bg-card); border-radius: var(--radius);
    border: 1px solid var(--border); padding: 16px 14px;
  }
  .pl-mini .pl-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); }
  .pl-mini .pl-val { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; margin-top: 4px; }
  .pl-mini .pl-val.positive { color: var(--accent); }
  .pl-mini .pl-val.negative { color: var(--red); }

  /* Account list */
  .account-card {
    background: var(--bg-card); border-radius: var(--radius);
    border: 1px solid var(--border); overflow: hidden; margin-bottom: 10px;
  }
  .account-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 16px; cursor: pointer; transition: background 0.15s;
  }
  .account-row:active { background: var(--bg-card-inner); }
  .account-row-left { display: flex; align-items: center; gap: 12px; }
  .account-dot { width: 10px; height: 10px; border-radius: 50%; }
  .account-name { font-size: 14px; font-weight: 500; }
  .account-shares { font-size: 11px; color: var(--text-secondary); margin-top: 1px; }
  .account-row-right { text-align: right; }
  .account-value { font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 600; }
  .account-pl { font-size: 11px; margin-top: 2px; }
  .account-pl.positive { color: var(--accent); }
  .account-pl.negative { color: var(--red); }

  /* Expanded detail */
  .account-detail {
    max-height: 0; overflow: hidden; transition: max-height 0.35s ease;
    border-top: 1px solid var(--border);
  }
  .account-detail.open { max-height: 300px; }
  .detail-inner { padding: 12px 16px 16px; }
  .detail-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 13px; }
  .detail-row .dl { color: var(--text-secondary); }
  .detail-row .dr { font-weight: 500; }

  /* Holdings list */
  .holding-item { border-bottom: 1px solid var(--border); }
  .holding-item:last-child { border-bottom: none; }
  .holding-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; cursor: pointer; transition: background 0.15s;
  }
  .holding-row:active { background: var(--bg-card-inner); }
  .holding-ticker { font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 700; }
  .holding-name { font-size: 11px; color: var(--text-secondary); margin-top: 1px; }
  .holding-right { text-align: right; }
  .holding-price { font-size: 14px; font-weight: 600; }
  .holding-pl { font-size: 11px; margin-top: 2px; }
  .holding-pl.positive { color: var(--accent); }
  .holding-pl.negative { color: var(--red); }

  /* Holding expanded detail */
  .holding-detail {
    max-height: 0; overflow: hidden; transition: max-height 0.35s ease;
    border-top: 1px solid var(--border);
  }
  .holding-detail.open { max-height: 400px; }

  /* Last updated */
  .last-updated { text-align: center; color: var(--text-secondary); font-size: 11px; padding: 8px 0 20px; }

  /* Toast */
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(120px);
    background: #2a2d3a; color: var(--text-primary); padding: 12px 22px;
    border-radius: 12px; font-size: 13px; transition: transform 0.3s ease;
    z-index: 100; white-space: nowrap; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€â”€ UTILITY â”€â”€â”€ */
  .hidden { display: none !important; }
  .text-positive { color: var(--accent); }
  .text-negative { color: var(--red); }
</style>
</head>
<body>

<!-- â”€â”€ Auth Screen â”€â”€ -->
<div id="auth-screen" class="screen active">
  <div class="logo-wrap">
    <div class="logo-icon">ðŸ“Š</div>
    <h1>Portfolio Tracker</h1>
    <p>Sign in to view your dashboard</p>
  </div>
  <button class="btn" id="signin-btn">
    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
    Sign in with Google
  </button>
</div>

<!-- â”€â”€ Loading Screen â”€â”€ -->
<div id="loading-screen" class="screen">
  <div class="spinner"></div>
  <p id="loading-msg">Fetching your portfolioâ€¦</p>
</div>

<!-- â”€â”€ Main Dashboard â”€â”€ -->
<div id="dashboard" class="screen dashboard">
  <div class="header">
    <h2>Portfolio</h2>
    <div class="header-actions">
      <button class="icon-btn" id="theme-btn" title="Toggle theme">
        <svg class="theme-icon moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        <svg class="theme-icon sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
      </button>
      <button class="icon-btn" id="refresh-btn" title="Refresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
      </button>
      <button class="icon-btn" id="signout-btn" title="Sign out">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
    </div>
  </div>

  <div class="dash-body">
    <!-- Hero -->
    <div class="hero-card">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
        <div class="hero-label">Total Portfolio Value</div>
        <button class="chart-toggle-btn" id="charts-toggle-btn" title="Toggle charts">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        </button>
      </div>
      <div class="hero-value" id="hero-value">â€”</div>
      <div class="hero-change positive" id="hero-change" style="display:none;">
        <svg viewBox="0 0 12 12" fill="currentColor"><polygon points="6,1 11,9 1,9"/></svg>
        <span id="hero-change-text">+0.00%</span>
      </div>
      <div class="hero-meta">
        <div class="hero-meta-item">
          <div class="hm-label">Total P/L</div>
          <div class="hm-val" id="hero-pl">â€”</div>
        </div>
        <div class="hero-meta-item">
          <div class="hm-label">P/L %</div>
          <div class="hm-val" id="hero-pl-pct">â€”</div>
        </div>
        <div class="hero-meta-item">
          <div class="hm-label">Today</div>
          <div class="hm-val" id="hero-date">â€”</div>
        </div>
      </div>
    </div>

    <!-- Charts Section (collapsible) -->
    <div class="charts-section" id="charts-section" style="display:none;">
      <div class="chart-header">
        <div class="chart-tabs">
          <button class="chart-tab active" data-chart="value">Portfolio Value</button>
          <button class="chart-tab" data-chart="performance">Performance</button>
        </div>
        <div class="chart-periods">
          <button class="period-btn active" data-period="1W">1W</button>
          <button class="period-btn" data-period="1M">1M</button>
          <button class="period-btn" data-period="3M">3M</button>
          <button class="period-btn" data-period="6M">6M</button>
          <button class="period-btn" data-period="YTD">YTD</button>
          <button class="period-btn" data-period="1Y">1Y</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="main-chart"></canvas>
      </div>
      <div id="chart-message" class="chart-message"></div>
    </div>

    <!-- Sleeves Section -->
    <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>Sleeves</span>
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="sleeves-sort" style="background:var(--bg-card-inner);border:1px solid var(--border);color:var(--text-secondary);padding:4px 8px;border-radius:8px;font-size:11px;cursor:pointer;">
          <option value="value">Value â†“</option>
          <option value="pl">P/L â†“</option>
          <option value="alpha">A-Z</option>
        </select>
        <button class="icon-btn" id="sleeves-toggle-btn" title="Toggle sleeves">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
        </button>
      </div>
    </div>
    <div id="sleeves-list"></div>

    <!-- Daily Change mini cards -->
    <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>Daily Snapshot</span>
      <select id="snapshot-view" style="background:var(--bg-card-inner);border:1px solid var(--border);color:var(--text-secondary);padding:4px 8px;border-radius:8px;font-size:11px;cursor:pointer;">
        <option value="overall">Overall</option>
        <option value="accounts">By Account</option>
      </select>
    </div>
    <div id="snapshot-overall">
      <div class="pl-row">
        <div class="pl-mini">
          <div class="pl-label">Yesterday's Close</div>
          <div class="pl-val" id="snap-yesterday">â€”</div>
        </div>
        <div class="pl-mini">
          <div class="pl-label">Today's Change</div>
          <div class="pl-val" id="snap-change">â€”</div>
        </div>
      </div>
    </div>
    <div id="snapshot-accounts" style="display:none;">
      <div id="account-snapshots"></div>
    </div>

    <!-- Accounts -->
    <div class="section-title">Accounts</div>
    <div id="accounts-list"></div>

    <!-- Top Holdings -->
    <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>Holdings</span>
      <select id="holdings-sort" style="background:var(--bg-card-inner);border:1px solid var(--border);color:var(--text-secondary);padding:4px 8px;border-radius:8px;font-size:11px;cursor:pointer;">
        <option value="value">Value â†“</option>
        <option value="ticker">Ticker A-Z</option>
        <option value="pl-pct">P/L % â†“</option>
        <option value="pl-dollar">P/L $ â†“</option>
      </select>
    </div>
    <div class="account-card" id="holdings-card"></div>

    <div class="last-updated" id="last-updated"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CLIENT_ID    = '564704335340-tr2sgmjopla69831iqe9g21k4ui53m2d.apps.googleusercontent.com';
const SHEET_ID     = '1aC2V0GQDKz9PiCGn40bfkITbpWmNOtwXl88V2-OikbQ';
const SHEET_GID    = '289436797';
const SCOPES       = 'https://www.googleapis.com/auth/spreadsheets.readonly';
const REDIRECT_URI = window.location.origin + window.location.pathname;

// Summary cells for daily tracking
const YESTERDAY_CLOSE_CELL = 'AH52';  // Yesterday's Close
const TODAY_CHANGE_CELL    = 'AH53';  // Today's Change %

// â”€â”€â”€ ACCOUNT DEFINITIONS (column indices, 0-based) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Adjust these if your columns shift. Based on your header order:
// A=Ticker, B=Name,
// C=Shares(NFCU) D=CostPS(NFCU) E=PL(NFCU)
// F=Shares(401K) G=CostPS(401K) H=PL(401K)
// I=Shares(Etrade) J=CostPS(Etrade) K=PL(Etrade)
// L=Shares(Fidelity) M=CostPS(Fidelity) N=PL(Fidelity)
// O=Shares(RolloverIRA) P=CostPS(Rollover) Q=PL(Rollover)
// R=Shares(RothIRA) S=CostPS(Roth) T=PL(Roth)
// U=Shares(Robinhood) V=CostPS(Robinhood) W=PL(Robinhood)
// X=Shares(Crypto.com) Y=CostPS(Crypto) Z=PL(Crypto)
// AA=Shares(RothIRA-LV) AB=CostPS(RothLV) AC=PL(RothLV)
// AD=TotalShares AE=AvgCostPS AF=CurrentPrice AG=Value AH=%P/L AI=%ofPortfolio

const ACCOUNTS = [
  { name:'NFCU (Taxable)',       color:'#5b9ef5', sharesCol:2,  costCol:3,  plCol:4,  logSheetIdx:0 },
  { name:'401K (Pre-tax)',       color:'#f5a85b', sharesCol:5,  costCol:6,  plCol:7,  logSheetIdx:1 },
  { name:'Etrade (Taxable)',     color:'#e05bf5', sharesCol:8,  costCol:9,  plCol:10, logSheetIdx:2 },
  { name:'Fidelity (Taxable)',   color:'#5bf5c4', sharesCol:11, costCol:12, plCol:13, logSheetIdx:3 },
  { name:'Rollover IRA',         color:'#f55b5b', sharesCol:14, costCol:15, plCol:16, logSheetIdx:4 },
  { name:'Roth IRA',             color:'#5be8f5', sharesCol:17, costCol:18, plCol:19, logSheetIdx:5 },
  { name:'Robinhood (Taxable)',  color:'#d4f55b', sharesCol:20, costCol:21, plCol:22, logSheetIdx:6 },
  { name:'Crypto.com (Taxable)', color:'#f5d45b', sharesCol:23, costCol:24, plCol:25, logSheetIdx:7 },
  { name:'Roth IRA-LV',         color:'#a85bf5', sharesCol:26, costCol:27, plCol:28, logSheetIdx:8 },
];

// Summary row columns (0-based) â€” AG=32 (Value), AH=33 (%P/L), AI=34 (% of Portfolio)
const TOTAL_SHARES_COL = 29; // AD
const AVG_COST_COL     = 30; // AE
const PRICE_COL        = 31; // AF
const VALUE_COL        = 32; // AG
const PL_PCT_COL       = 33; // AH
const PORT_PCT_COL     = 34; // AI

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let accessToken = null;
let sheetData   = [];
let holdingsData = []; // Store holdings for sorting
let logSheetData = []; // Store LogSheet data for charts
let currentChart = null; // Chart.js instance
let currentChartType = 'value'; // 'value' or 'performance'
let currentPeriod = '1W'; // default period
let sleevesData = []; // Store sleeves for sorting
let sleevesSortBy = 'value'; // default sort
let sleevesVisible = true; // default visible

// â”€â”€â”€ THEME MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'dark';
  if (savedTheme === 'light') {
    document.documentElement.classList.add('light-mode');
  }
}

function toggleTheme() {
  const isLight = document.documentElement.classList.toggle('light-mode');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  // Update meta theme-color for mobile browsers
  const themeColor = isLight ? '#f5f7fa' : '#0f1117';
  document.querySelector('meta[name="theme-color"]').setAttribute('content', themeColor);
}

// â”€â”€â”€ DOM REFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const authScreen    = document.getElementById('auth-screen');
const loadingScreen = document.getElementById('loading-screen');
const dashScreen    = document.getElementById('dashboard');
const loadingMsg    = document.getElementById('loading-msg');
const toastEl       = document.getElementById('toast');

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, dur=2400) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(() => toastEl.classList.remove('show'), dur);
}

// â”€â”€â”€ SCREEN HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  [authScreen, loadingScreen, dashScreen].forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// â”€â”€â”€ OAUTH FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initiateLogin() {
  const params = new URLSearchParams({
    client_id:     CLIENT_ID,
    redirect_uri:  REDIRECT_URI,
    response_type: 'code',
    scope:         SCOPES,
    access_type:   'offline',
    prompt:        'consent'
  });
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params;
}

async function exchangeCode(code) {
  // For a PWA we use the implicit flow instead; fall back to token extraction.
  // Re-initiate with response_type=token for simplicity (no backend needed).
  const params = new URLSearchParams({
    client_id:     CLIENT_ID,
    redirect_uri:  REDIRECT_URI,
    response_type: 'token',
    scope:         SCOPES,
    access_type:   'online',
    prompt:        'consent'
  });
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params;
}

function parseHashParams() {
  const hash = window.location.hash.substring(1);
  if (!hash) return null;
  const params = new URLSearchParams(hash);
  return {
    access_token: params.get('access_token'),
    expires_in:   params.get('expires_in'),
    token_type:   params.get('token_type'),
    state:        params.get('state'),
  };
}

// â”€â”€â”€ FETCH SHEET DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSheetData() {
  // Use Sheets API v4 to get all values from the target gid sheet
  // First we need the sheet name for the gid. We'll fetch sheet metadata.
  const metaRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?fields=sheets.properties`,
    { headers: { 'Authorization': 'Bearer ' + accessToken } }
  );
  if (!metaRes.ok) throw new Error('Failed to fetch sheet metadata: ' + metaRes.status);
  const meta = await metaRes.json();
  const sheet = meta.sheets.find(s => String(s.properties.sheetId) === SHEET_GID);
  if (!sheet) throw new Error('Sheet GID not found. Check your Sheet ID.');
  const sheetName = sheet.properties.title;

  // Now fetch all rows, summary cells, AND LogSheet data in a batch request
  const batchRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet?` +
    `ranges=${encodeURIComponent(sheetName)}&` +
    `ranges=${encodeURIComponent(sheetName + '!' + YESTERDAY_CLOSE_CELL)}&` +
    `ranges=${encodeURIComponent(sheetName + '!' + TODAY_CHANGE_CELL)}&` +
    `ranges=${encodeURIComponent('LogSheet!A:L')}`,
    { headers: { 'Authorization': 'Bearer ' + accessToken } }
  );
  if (!batchRes.ok) throw new Error('Failed to fetch sheet data: ' + batchRes.status);
  const batchJson = await batchRes.json();
  
  return {
    rows: batchJson.valueRanges[0].values || [],
    yesterdayClose: batchJson.valueRanges[1].values?.[0]?.[0] || 'No data',
    todayChange: batchJson.valueRanges[2].values?.[0]?.[0] || 'N/A',
    logSheetData: batchJson.valueRanges[3].values || []
  };
}

// â”€â”€â”€ PARSE & RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseNum(v) {
  if (v == null || v === '') return 0;
  return parseFloat(String(v).replace(/[,$%]/g, '')) || 0;
}

function fmt(n) {
  return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtPct(n) {
  return (n >= 0 ? '+' : '') + (n * 100).toFixed(2) + '%';
}
function plClass(n) { return n >= 0 ? 'positive' : 'negative'; }

function renderDashboard(rows, yesterdayClose, todayChange) {
  // Row 0 = header. Data rows = 1 .. N-1
  // We assume the last meaningful rows contain summary totals if any.
  // We'll iterate all data rows and build per-account and per-holding summaries.

  const headerRow = rows[0] || [];
  const dataRows  = rows.slice(1).filter(r => r && r[0] && r[0].trim() !== '');

  // â”€â”€ Totals across all holdings â”€â”€
  let totalValue = 0, totalPL = 0, totalCost = 0;
  const accountTotals = ACCOUNTS.map(a => ({ ...a, value:0, pl:0, shares:0 }));
  const holdings = [];

  dataRows.forEach(row => {
    const ticker  = (row[0] || '').trim();
    const name    = (row[1] || '').trim();
    const price   = parseNum(row[PRICE_COL]);
    const value   = parseNum(row[VALUE_COL]);
    const totalSh = parseNum(row[TOTAL_SHARES_COL]);
    const avgCost = parseNum(row[AVG_COST_COL]);

    if (!ticker || ticker.toLowerCase() === 'ticker') return; // skip if header snuck in

    totalValue += value;

    // Per-account
    ACCOUNTS.forEach((acc, i) => {
      const sh = parseNum(row[acc.sharesCol]);
      const pl = parseNum(row[acc.plCol]);
      accountTotals[i].shares += sh;
      accountTotals[i].pl     += pl;
      accountTotals[i].value  += sh * price;
    });

    // Holding P/L = value - (totalShares * avgCost)
    const holdingCost = totalSh * avgCost;
    const holdingPL   = value - holdingCost;
    totalPL   += holdingPL;
    totalCost += holdingCost;
    
    // Sleeve info (columns: Guard-rail=35, Breach=36, Sleeve=37)
    const target = parseNum(row[35]); // Guard-rail column (AI)
    const breach = (row[36] || '').toString().toLowerCase() === 'yes';
    const sleeve = (row[37] || '').trim() || 'Other';

    holdings.push({ ticker, name, price, value, totalSh, avgCost, pl: holdingPL, target, breach, sleeve });
  });

  // Sort holdings by value desc
  holdings.sort((a, b) => b.value - a.value);
  // Sort accounts by value desc
  accountTotals.sort((a, b) => b.value - a.value);

  const plPct = totalCost > 0 ? (totalPL / totalCost) : 0;

  // â”€â”€ Hero â”€â”€
  document.getElementById('hero-value').textContent = fmt(totalValue);
  const heroPlEl = document.getElementById('hero-pl');
  heroPlEl.textContent = fmt(totalPL);
  heroPlEl.className = 'hm-val ' + plClass(totalPL);

  const heroPlPctEl = document.getElementById('hero-pl-pct');
  heroPlPctEl.textContent = fmtPct(plPct);
  heroPlPctEl.className = 'hm-val ' + plClass(plPct);

  document.getElementById('hero-date').textContent = new Date().toLocaleDateString('en-US',{ month:'short', day:'numeric' });

  // Hero change badge â€” use todayChange if available
  const changeEl = document.getElementById('hero-change');
  changeEl.style.display = 'inline-flex';
  
  let displayChange = plPct;
  if (todayChange !== 'N/A' && todayChange !== 'No data') {
    // todayChange comes as a decimal (0.05 = 5%), already in correct format
    displayChange = parseNum(todayChange);
  }
  
  changeEl.className = 'hero-change ' + plClass(displayChange);
  document.getElementById('hero-change-text').textContent = fmtPct(displayChange);
  // Flip triangle
  changeEl.querySelector('svg polygon').setAttribute('points',
    displayChange >= 0 ? '6,1 11,9 1,9' : '6,11 11,3 1,3'
  );

  // â”€â”€ Daily Snapshot â”€â”€
  const snapYesterdayEl = document.getElementById('snap-yesterday');
  if (yesterdayClose !== 'No data' && yesterdayClose !== 'N/A') {
    const ycVal = parseNum(yesterdayClose);
    snapYesterdayEl.textContent = fmt(ycVal);
  } else {
    snapYesterdayEl.textContent = 'No data';
  }
  
  const snapChangeEl = document.getElementById('snap-change');
  if (todayChange !== 'N/A' && todayChange !== 'No data') {
    const tcVal = parseNum(todayChange);
    const dollarChange = totalValue * tcVal;
    snapChangeEl.textContent = fmt(dollarChange);
    snapChangeEl.className = 'pl-val ' + plClass(tcVal);
  } else {
    snapChangeEl.textContent = 'N/A';
    snapChangeEl.className = 'pl-val';
  }

  // â”€â”€ Accounts â”€â”€
  const accountsList = document.getElementById('accounts-list');
  accountsList.innerHTML = '';
  
  // Filter out $0 accounts
  const nonZeroAccounts = accountTotals.filter(acc => acc.value > 0);
  
  nonZeroAccounts.forEach((acc, idx) => {
    const plPctAcc = acc.value > 0 ? ((acc.pl / (acc.value - acc.pl)) || 0) : 0;
    
    // Calculate actual daily change for this account from LogSheet
    // Use logSheetIdx to get the correct column
    let dailyChange = 0;
    let dailyChangePct = 0;
    
    if (logSheetData && logSheetData.length > 2) { // Need header + at least 2 data rows
      // Today's row is last, yesterday's is second to last
      const todayRow = logSheetData[logSheetData.length - 1];
      const yesterdayRow = logSheetData[logSheetData.length - 2];
      
      const todayAccValue = parseNum(todayRow[3 + acc.logSheetIdx]); // Use logSheetIdx instead of idx
      const yesterdayAccValue = parseNum(yesterdayRow[3 + acc.logSheetIdx]);
      
      if (yesterdayAccValue > 0 && todayAccValue > 0) {
        dailyChange = todayAccValue - yesterdayAccValue;
        dailyChangePct = dailyChange / yesterdayAccValue;
      }
    }
    
    accountsList.innerHTML += `
      <div class="account-card">
        <div class="account-row" onclick="toggleDetail(${idx})">
          <div class="account-row-left">
            <div class="account-dot" style="background:${acc.color}"></div>
            <div>
              <div class="account-name">${acc.name}</div>
              <div class="account-shares">${acc.shares.toFixed(2)} total shares</div>
            </div>
          </div>
          <div class="account-row-right">
            <div class="account-value">${fmt(acc.value)}</div>
            <div class="account-pl ${plClass(acc.pl)}">${acc.pl >= 0 ? '+' : ''}${fmt(acc.pl)} (${fmtPct(plPctAcc)})</div>
          </div>
        </div>
        <div class="account-detail" id="detail-${idx}">
          <div class="detail-inner">
            <div class="detail-row"><span class="dl">Total Shares</span><span class="dr">${acc.shares.toFixed(4)}</span></div>
            <div class="detail-row"><span class="dl">Total Value</span><span class="dr">${fmt(acc.value)}</span></div>
            <div class="detail-row"><span class="dl">Daily Change</span><span class="dr ${plClass(dailyChange)}">${dailyChange !== 0 ? (dailyChange >= 0 ? '+' : '') + fmt(dailyChange) + ' (' + fmtPct(dailyChangePct) + ')' : 'N/A'}</span></div>
            <div class="detail-row"><span class="dl">Total P/L</span><span class="dr ${plClass(acc.pl)}">${acc.pl >= 0 ? '+' : ''}${fmt(acc.pl)}</span></div>
            <div class="detail-row"><span class="dl">P/L %</span><span class="dr ${plClass(plPctAcc)}">${fmtPct(plPctAcc)}</span></div>
          </div>
        </div>
      </div>`;
  });

  // â”€â”€ Holdings â”€â”€
  holdingsData = holdings; // Store for sorting
  renderHoldings();

  // Last updated
  document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
  
  // Render account snapshots (for toggle view)
  renderAccountSnapshots(accountTotals);
  
  // â”€â”€ Sleeves â”€â”€
  renderSleeves(holdings, totalValue);
}

function renderAccountSnapshots(accountTotals) {
  const container = document.getElementById('account-snapshots');
  container.innerHTML = '';
  
  // Filter out $0 accounts
  const nonZeroAccounts = accountTotals.filter(acc => acc.value > 0);
  
  nonZeroAccounts.forEach((acc, idx) => {
    let dailyChange = 0;
    let dailyChangePct = 0;
    
    if (logSheetData && logSheetData.length > 2) {
      const todayRow = logSheetData[logSheetData.length - 1];
      const yesterdayRow = logSheetData[logSheetData.length - 2];
      
      const todayAccValue = parseNum(todayRow[3 + acc.logSheetIdx]); // Use logSheetIdx
      const yesterdayAccValue = parseNum(yesterdayRow[3 + acc.logSheetIdx]);
      
      if (yesterdayAccValue > 0 && todayAccValue > 0) {
        dailyChange = todayAccValue - yesterdayAccValue;
        dailyChangePct = dailyChange / yesterdayAccValue;
      }
    }
    
    container.innerHTML += `
      <div class="account-snapshot-card" style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <div class="account-dot" style="background:${acc.color}"></div>
          <div style="font-size:12px;font-weight:600;">${acc.name}</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;">Value</div>
            <div style="font-size:16px;font-weight:700;font-family:'Space Mono',monospace;">${fmt(acc.value)}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;">Change</div>
            <div style="font-size:14px;font-weight:600;" class="${plClass(dailyChange)}">${dailyChange !== 0 ? (dailyChange >= 0 ? '+' : '') + fmt(dailyChange) : 'N/A'}</div>
            <div style="font-size:11px;" class="${plClass(dailyChangePct)}">${dailyChangePct !== 0 ? fmtPct(dailyChangePct) : ''}</div>
          </div>
        </div>
      </div>`;
  });
}

function renderSleeves(holdings, totalPortfolioValue) {
  // Group holdings by sleeve
  const sleevesMap = {};
  holdings.forEach(h => {
    const sleeveName = h.sleeve || 'Other';
    if (!sleevesMap[sleeveName]) {
      sleevesMap[sleeveName] = {
        name: sleeveName,
        holdings: [],
        value: 0,
        pl: 0
      };
    }
    sleevesMap[sleeveName].holdings.push(h);
    sleevesMap[sleeveName].value += h.value;
    sleevesMap[sleeveName].pl += h.pl;
  });
  
  // Convert to array and filter out $0 sleeves
  sleevesData = Object.values(sleevesMap).filter(s => s.value > 0);
  
  // Sort based on current preference
  sortSleeves(sleevesSortBy);
  
  // Render
  displaySleeves(totalPortfolioValue);
}

function sortSleeves(sortType) {
  sleevesSortBy = sortType;
  switch(sortType) {
    case 'pl':
      sleevesData.sort((a, b) => b.pl - a.pl);
      break;
    case 'alpha':
      sleevesData.sort((a, b) => a.name.localeCompare(b.name));
      break;
    case 'value':
    default:
      sleevesData.sort((a, b) => b.value - a.value);
      break;
  }
}

function displaySleeves(totalPortfolioValue) {
  const sleevesList = document.getElementById('sleeves-list');
  
  if (!sleevesVisible) {
    sleevesList.style.display = 'none';
    return;
  }
  
  sleevesList.style.display = 'block';
  sleevesList.innerHTML = '';
  
  sleevesData.forEach((sleeve, idx) => {
    const portPct = totalPortfolioValue > 0 ? (sleeve.value / totalPortfolioValue) : 0;
    const costBasis = sleeve.value - sleeve.pl;
    const plPct = costBasis > 0 ? (sleeve.pl / costBasis) : 0;
    
    // Build holdings list HTML
    let holdingsHTML = '';
    sleeve.holdings.forEach(h => {
      const hPlPct = h.avgCost > 0 ? (h.pl / (h.totalSh * h.avgCost)) : 0;
      holdingsHTML += `
        <div class="sleeve-holding-row">
          <div>
            <div class="sleeve-holding-ticker">${h.ticker}</div>
            <div class="sleeve-holding-name">${h.name || 'â€”'}</div>
          </div>
          <div style="text-align:right;">
            <div class="sleeve-holding-value">${fmt(h.value)}</div>
            <div class="sleeve-holding-pl ${plClass(h.pl)}">${h.pl >= 0 ? '+' : ''}${fmt(h.pl)} (${fmtPct(hPlPct)})</div>
          </div>
        </div>`;
    });
    
    sleevesList.innerHTML += `
      <div class="sleeve-card">
        <div class="sleeve-row" onclick="toggleSleeveDetail(${idx})">
          <div>
            <div class="sleeve-name">${sleeve.name}</div>
            <div class="sleeve-allocation">${(portPct * 100).toFixed(1)}% of portfolio â€¢ ${sleeve.holdings.length} holdings</div>
          </div>
          <div class="sleeve-row-right">
            <div class="sleeve-value">${fmt(sleeve.value)}</div>
            <div class="sleeve-change ${plClass(sleeve.pl)}">${sleeve.pl >= 0 ? '+' : ''}${fmt(sleeve.pl)} (${fmtPct(plPct)})</div>
          </div>
        </div>
        <div class="sleeve-detail" id="sleeve-detail-${idx}">
          <div class="detail-inner">
            <div class="detail-row"><span class="dl">Total Value</span><span class="dr">${fmt(sleeve.value)}</span></div>
            <div class="detail-row"><span class="dl">% of Portfolio</span><span class="dr">${(portPct * 100).toFixed(2)}%</span></div>
            <div class="detail-row"><span class="dl">Total P/L</span><span class="dr ${plClass(sleeve.pl)}">${sleeve.pl >= 0 ? '+' : ''}${fmt(sleeve.pl)}</span></div>
            <div class="detail-row"><span class="dl">P/L %</span><span class="dr ${plClass(plPct)}">${fmtPct(plPct)}</span></div>
          </div>
          <div class="sleeve-holdings-section">
            <div class="sleeve-holdings-header">Holdings</div>
            ${holdingsHTML}
          </div>
        </div>
      </div>`;
  });
}

function toggleSleeveDetail(idx) {
  const el = document.getElementById('sleeve-detail-' + idx);
  el.classList.toggle('open');
}

function toggleSleevesVisibility() {
  sleevesVisible = !sleevesVisible;
  const btn = document.getElementById('sleeves-toggle-btn');
  const svg = btn.querySelector('svg polyline');
  
  if (sleevesVisible) {
    svg.setAttribute('points', '6 9 12 15 18 9'); // down arrow
  } else {
    svg.setAttribute('points', '9 18 15 12 9 6'); // right arrow
  }
  
  // Need to get totalPortfolioValue - we can calculate it from sleevesData
  const totalValue = sleevesData.reduce((sum, s) => sum + s.value, 0);
  displaySleeves(totalValue);
}

function toggleDetail(idx) {
  const el = document.getElementById('detail-' + idx);
  el.classList.toggle('open');
}

function toggleHoldingDetail(idx) {
  const el = document.getElementById('holding-detail-' + idx);
  el.classList.toggle('open');
}

function renderHoldings() {
  const holdingsCard = document.getElementById('holdings-card');
  holdingsCard.innerHTML = '';
  
  // Filter out $0 holdings
  const nonZeroHoldings = holdingsData.filter(h => h.value > 0);
  
  if (nonZeroHoldings.length === 0) {
    holdingsCard.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-secondary);font-size:13px;">No holdings to display</div>';
    return;
  }
  
  nonZeroHoldings.forEach((h, idx) => {
    const hPlPct = h.avgCost > 0 ? (h.pl / (h.totalSh * h.avgCost)) : 0;
    const costBasis = h.totalSh * h.avgCost;
    holdingsCard.innerHTML += `
      <div class="holding-item">
        <div class="holding-row" onclick="toggleHoldingDetail(${idx})">
          <div>
            <div class="holding-ticker">${h.ticker}</div>
            <div class="holding-name">${h.name || 'â€”'}</div>
          </div>
          <div class="holding-right">
            <div class="holding-price">${fmt(h.price)}</div>
            <div class="holding-pl ${plClass(h.pl)}">${h.pl >= 0 ? '+' : ''}${fmt(h.pl)} (${fmtPct(hPlPct)})</div>
          </div>
        </div>
        <div class="holding-detail" id="holding-detail-${idx}">
          <div class="detail-inner">
            <div class="detail-row"><span class="dl">Total Shares</span><span class="dr">${h.totalSh.toFixed(1)}</span></div>
            <div class="detail-row"><span class="dl">Avg Cost per Share</span><span class="dr">${fmt(h.avgCost)}</span></div>
            <div class="detail-row"><span class="dl">Cost Basis</span><span class="dr">${fmt(costBasis)}</span></div>
            <div class="detail-row"><span class="dl">Current Price</span><span class="dr">${fmt(h.price)}</span></div>
            <div class="detail-row"><span class="dl">Current Value</span><span class="dr">${fmt(h.value)}</span></div>
            <div class="detail-row"><span class="dl">Total P/L</span><span class="dr ${plClass(h.pl)}">${h.pl >= 0 ? '+' : ''}${fmt(h.pl)}</span></div>
            <div class="detail-row"><span class="dl">P/L %</span><span class="dr ${plClass(hPlPct)}">${fmtPct(hPlPct)}</span></div>
          </div>
        </div>
      </div>`;
  });
}

function sortHoldings(sortType) {
  const sorted = [...holdingsData];
  switch(sortType) {
    case 'ticker':
      sorted.sort((a, b) => a.ticker.localeCompare(b.ticker));
      break;
    case 'pl-pct':
      sorted.sort((a, b) => {
        const aPct = a.avgCost > 0 ? (a.pl / (a.totalSh * a.avgCost)) : 0;
        const bPct = b.avgCost > 0 ? (b.pl / (b.totalSh * b.avgCost)) : 0;
        return bPct - aPct;
      });
      break;
    case 'pl-dollar':
      sorted.sort((a, b) => b.pl - a.pl);
      break;
    case 'value':
    default:
      sorted.sort((a, b) => b.value - a.value);
      break;
  }
  holdingsData = sorted;
  renderHoldings();
}

// â”€â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterLogDataByPeriod(period) {
  if (!logSheetData || logSheetData.length <2) return [];
  
  const data = logSheetData.slice(1); // Skip header row
  const today = new Date();
  let cutoffDate;
  
  switch(period) {
    case '1W': cutoffDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000); break;
    case '1M': cutoffDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000); break;
    case '3M': cutoffDate = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000); break;
    case '6M': cutoffDate = new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000); break;
    case 'YTD': cutoffDate = new Date(today.getFullYear(), 0, 1); break;
    case '1Y': cutoffDate = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000); break;
    default: cutoffDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  }
  
  return data.filter(row => {
    const rowDate = new Date(row[0]);
    return rowDate >= cutoffDate;
  });
}

function renderChart(type, period) {
  const filteredData = filterLogDataByPeriod(period);
  const msgEl = document.getElementById('chart-message');
  
  if (filteredData.length < 2) {
    msgEl.textContent = 'Not enough data yet. Charts will appear as your portfolio history accumulates.';
    if (currentChart) currentChart.destroy();
    return;
  }
  
  msgEl.textContent = '';
  const canvas = document.getElementById('main-chart');
  const ctx = canvas.getContext('2d');
  
  if (currentChart) currentChart.destroy();
  
  const labels = filteredData.map(row => {
    const d = new Date(row[0]);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });
  
  let chartData, chartLabel, chartColor;
  
  if (type === 'value') {
    chartData = filteredData.map(row => parseNum(row[1]));
    chartLabel = 'Portfolio Value';
    chartColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  } else {
    // Performance chart - calculate cumulative return %
    const startValue = parseNum(filteredData[0][1]);
    const totalContributions = filteredData.reduce((sum, row) => sum + parseNum(row[2] || 0), 0);
    
    chartData = filteredData.map(row => {
      const currentValue = parseNum(row[1]);
      const contributions = parseNum(row[2] || 0);
      const trueGain = currentValue - startValue - totalContributions;
      return ((trueGain / (startValue + totalContributions)) * 100);
    });
    
    chartLabel = 'Performance %';
    chartColor = getComputedStyle(document.documentElement).getPropertyValue('--blue').trim();
  }
  
  currentChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: chartLabel,
        data: chartData,
        borderColor: chartColor,
        backgroundColor: chartColor + '20',
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointRadius: 3,
        pointHoverRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card-inner'),
          titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
          bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              if (type === 'value') {
                return chartLabel + ': ' + fmt(context.parsed.y);
              } else {
                return chartLabel + ': ' + context.parsed.y.toFixed(2) + '%';
              }
            }
          }
        }
      },
      scales: {
        y: {
          ticks: {
            color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
            callback: function(value) {
              if (type === 'value') return '$' + (value / 1000).toFixed(0) + 'k';
              return value.toFixed(1) + '%';
            }
          },
          grid: {
            color: getComputedStyle(document.documentElement).getPropertyValue('--border')
          }
        },
        x: {
          ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
          grid: { display: false }
        }
      }
    }
  });
}

function toggleCharts() {
  const chartsSection = document.getElementById('charts-section');
  if (chartsSection.style.display === 'none') {
    chartsSection.style.display = 'block';
    renderChart(currentChartType, currentPeriod);
  } else {
    chartsSection.style.display = 'none';
  }
}

// â”€â”€â”€ MAIN FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  // Check for token in URL hash (implicit flow callback)
  const hashParams = parseHashParams();
  if (hashParams && hashParams.access_token) {
    accessToken = hashParams.access_token;
    // Clean URL
    history.replaceState(null, '', window.location.pathname);
    await loadData();
    return;
  }

  // Check for auth code in URL search params (auth code flow callback)
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  if (code) {
    // We can't exchange code without a backend, so re-initiate with implicit flow
    showScreen('loading-screen');
    loadingMsg.textContent = 'Redirecting for authenticationâ€¦';
    await exchangeCode(code);
    return;
  }

  // No token, no code â€” show sign-in
  showScreen('auth-screen');
}

async function loadData() {
  showScreen('loading-screen');
  loadingMsg.textContent = 'Fetching your portfolioâ€¦';
  try {
    const { rows, yesterdayClose, todayChange, logSheetData: logData } = await fetchSheetData();
    sheetData = rows;
    logSheetData = logData;
    renderDashboard(rows, yesterdayClose, todayChange);
    showScreen('dashboard');
  } catch (err) {
    console.error(err);
    showToast('Error: ' + err.message);
    showScreen('auth-screen');
  }
}

// â”€â”€â”€ EVENT LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('signin-btn').addEventListener('click', () => {
  // Use implicit flow (response_type=token) â€” no backend needed
  const params = new URLSearchParams({
    client_id:     CLIENT_ID,
    redirect_uri:  REDIRECT_URI,
    response_type: 'token',
    scope:         SCOPES,
    access_type:   'online',
    prompt:        'consent'
  });
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params;
});

document.getElementById('refresh-btn').addEventListener('click', () => {
  if (accessToken) loadData();
  else showToast('Please sign in first.');
});

document.getElementById('signout-btn').addEventListener('click', () => {
  accessToken = null;
  sheetData = [];
  showScreen('auth-screen');
  showToast('Signed out.');
});

document.getElementById('holdings-sort').addEventListener('change', (e) => {
  sortHoldings(e.target.value);
});

document.getElementById('theme-btn').addEventListener('click', toggleTheme);

document.getElementById('charts-toggle-btn').addEventListener('click', toggleCharts);

// Chart tab switching
document.querySelectorAll('.chart-tab').forEach(tab => {
  tab.addEventListener('click', (e) => {
    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
    e.target.classList.add('active');
    currentChartType = e.target.dataset.chart;
    renderChart(currentChartType, currentPeriod);
  });
});

// Period switching
document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    currentPeriod = e.target.dataset.period;
    renderChart(currentChartType, currentPeriod);
  });
});

// Snapshot view switching
document.getElementById('snapshot-view').addEventListener('change', (e) => {
  const overallView = document.getElementById('snapshot-overall');
  const accountsView = document.getElementById('snapshot-accounts');
  
  if (e.target.value === 'accounts') {
    overallView.style.display = 'none';
    accountsView.style.display = 'block';
  } else {
    overallView.style.display = 'block';
    accountsView.style.display = 'none';
  }
});

// Sleeves toggle
document.getElementById('sleeves-toggle-btn').addEventListener('click', toggleSleevesVisibility);

// Sleeves sorting
document.getElementById('sleeves-sort').addEventListener('change', (e) => {
  sortSleeves(e.target.value);
  const totalValue = sleevesData.reduce((sum, s) => sum + s.value, 0);
  displaySleeves(totalValue);
});

// â”€â”€â”€ GO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadTheme();
init();
</script>
</body>
</html>
